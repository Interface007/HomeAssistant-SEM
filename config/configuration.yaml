
# Loads default set of integrations. Do not remove.
default_config:

# Load frontend themes from the themes folder
frontend:
  themes: !include_dir_merge_named themes

automation: !include automations.yaml
script: !include scripts.yaml
scene: !include scenes.yaml
template: !include templates.yaml

rest_command:
  # bathroom
  shellytrv_bad_set_external_temperature:
    # Variable "temperature": Temperatur in °C (als Float)
    url: http://192.168.2.23/ext_t?temp={{temperature}}
  shellytrv_bad_set_window_state:
    # Variable "state": "open" (Fenster offen) oder "close" (Fenster geschlossen)
    url: http://192.168.2.23/window?state={{state}}
  # LEA
  shellytrv_lea_set_external_temperature:
    # Variable "temperature": Temperatur in °C (als Float)
    url: http://192.168.2.33/ext_t?temp={{temperature}}
  shellytrv_lea_set_window_state:
    # Variable "state": "open" (Fenster offen) oder "close" (Fenster geschlossen)
    url: http://192.168.2.33/window?state={{state}}
  # ... Services für die anderen Thermostate

sensor:
  - platform: template
    sensors:
      teams_status: 
        friendly_name: "Microsoft Teams status"
        value_template: "{{states('input_text.teams_status')}}"
        icon_template: "{{state_attr('input_text.teams_status','icon')}}"
        unique_id: sensor.teams_status
      teams_activity:
        friendly_name: "Microsoft Teams activity"
        value_template: "{{states('input_text.teams_activity')}}"
        unique_id: sensor.teams_activity
      rel_humidity_livingroomwall:
        friendly_name: "Relative Feuchte an der Wohnzimmerwand"
        icon_template: "mdi:water-percent-alert"
        unit_of_measurement: '%'
        value_template: >
          {% set t_luft = states('sensor.klima_wohnzimmer_temperatur') | float %}
          {% set rh_luft = states('sensor.klima_wohnzimmer_luftfeuchtigkeit') | float %}
          {% set t_wand = states('sensor.esphome_web_e866d8_temperatur_wand_wohnzimmer') | float %}
          {# 1. Taupunkt berechnen #}
          {% set a = 17.625 %}
          {% set b = 243.04 %}
          {% set alpha = (rh_luft/100) | log + (a * t_luft)/(b + t_luft) %}
          {% set t_tau = (b * alpha) / (a - alpha) %}
          {# 2. Dampfdruck der Luft #}
          {% set e = 6.1094 * (2.718281828459045 ** ((a * t_tau)/(b + t_tau))) %}
          {# 3. Sättigungsdampfdruck an der Wand #}
          {% set e_s = 6.1094 * (2.718281828459045 ** ((a * t_wand)/(b + t_wand))) %}
          {# 4. Relative Feuchte an der Wand #}
          {{ ((e / e_s) * 100) | round(1) }}
      rel_humidity_bedroomwall:
        friendly_name: "Relative Feuchte an der Schlafzimmerwand"
        icon_template: "mdi:water-percent-alert"
        unit_of_measurement: '%'
        value_template: >
          {% set t_luft = states('sensor.klima_schlafzimmer_temperatur') | float %}
          {% set rh_luft = states('sensor.klima_schlafzimmer_luftfeuchtigkeit') | float %}
          {% set t_wand = states('sensor.esphome_web_e866d8_temperatur_wand_wohnzimmer') | float %}
          {# 1. Taupunkt berechnen #}
          {% set a = 17.625 %}
          {% set b = 243.04 %}
          {% set alpha = (rh_luft/100) | log + (a * t_luft)/(b + t_luft) %}
          {% set t_tau = (b * alpha) / (a - alpha) %}
          {# 2. Dampfdruck der Luft #}
          {% set e = 6.1094 * (2.718281828459045 ** ((a * t_tau)/(b + t_tau))) %}
          {# 3. Sättigungsdampfdruck an der Wand #}
          {% set e_s = 6.1094 * (2.718281828459045 ** ((a * t_wand)/(b + t_wand))) %}
          {# 4. Relative Feuchte an der Wand #}
          {{ ((e / e_s) * 100) | round(1) }}
      rel_humidity_annawall:
        friendly_name: "Relative Feuchte an der Wand Anna"
        icon_template: "mdi:water-percent-alert"
        unit_of_measurement: '%'
        value_template: >
          {% set t_luft = states('sensor.klima_ann_temperatur') | float %}
          {% set rh_luft = states('sensor.klima_anna_luftfeuchtigkeit') | float %}
          {% set t_wand = states('sensor.esphome_web_e866d8_temperatur_wand_wohnzimmer') | float %}
          {# 1. Taupunkt berechnen #}
          {% set a = 17.625 %}
          {% set b = 243.04 %}
          {% set alpha = (rh_luft/100) | log + (a * t_luft)/(b + t_luft) %}
          {% set t_tau = (b * alpha) / (a - alpha) %}
          {# 2. Dampfdruck der Luft #}
          {% set e = 6.1094 * (2.718281828459045 ** ((a * t_tau)/(b + t_tau))) %}
          {# 3. Sättigungsdampfdruck an der Wand #}
          {% set e_s = 6.1094 * (2.718281828459045 ** ((a * t_wand)/(b + t_wand))) %}
          {# 4. Relative Feuchte an der Wand #}
          {{ ((e / e_s) * 100) | round(1) }}
      rel_humidity_leawall:
        friendly_name: "Relative Feuchte an der Wand Lea"
        icon_template: "mdi:water-percent-alert"
        unit_of_measurement: '%'
        value_template: >
          {% set t_luft = states('sensor.klima_lea_temperatur') | float %}
          {% set rh_luft = states('sensor.klima_lea_luftfeuchtigkeit') | float %}
          {% set t_wand = states('sensor.esphome_web_e866d8_temperatur_wand_wohnzimmer') | float %}
          {# 1. Taupunkt berechnen #}
          {% set a = 17.625 %}
          {% set b = 243.04 %}
          {% set alpha = (rh_luft/100) | log + (a * t_luft)/(b + t_luft) %}
          {% set t_tau = (b * alpha) / (a - alpha) %}
          {# 2. Dampfdruck der Luft #}
          {% set e = 6.1094 * (2.718281828459045 ** ((a * t_tau)/(b + t_tau))) %}
          {# 3. Sättigungsdampfdruck an der Wand #}
          {% set e_s = 6.1094 * (2.718281828459045 ** ((a * t_wand)/(b + t_wand))) %}
          {# 4. Relative Feuchte an der Wand #}
          {{ ((e / e_s) * 100) | round(1) }}
  - platform: sensor_history
    entity_id: sensor.watermeter_value
    name: "epaper_watermeter_history"
    bearertoken: !secret bearer_token
  - platform: sensor_history
    entity_id: sensor.power_main_total_active_power
    name: "epaper_power_history"
    factor: 1
    mode: "absolute"
    aggregate: "sum"
    aggregate_key: "hour"
    bearertoken: !secret bearer_token
  - platform: filter
    name: "Panel 1 (Moving Average)"
    entity_id: sensor.solarbank_3_e2700_pro_solar_pv1
    filters:
      - filter: time_simple_moving_average
        window_size: "00:30"
        precision: 0
  - platform: filter
    name: "Panel 2 (Moving Average)"
    entity_id: sensor.solarbank_3_e2700_pro_solar_pv2
    filters:
      - filter: time_simple_moving_average
        window_size: "00:30"
        precision: 0
  - platform: filter
    name: "Panel 3 (Moving Average)"
    entity_id: sensor.solarbank_3_e2700_pro_solar_pv3
    filters:
      - filter: time_simple_moving_average
        window_size: "00:30"
        precision: 0
  - platform: filter
    name: "Panel 4 (Moving Average)"
    entity_id: sensor.solarbank_3_e2700_pro_solar_pv4
    filters:
      - filter: time_simple_moving_average
        window_size: "00:30"
        precision: 0
  - platform: template
    sensors:
      power_main_total_active_power_rounded:
        friendly_name: "Enwag → Haus"
        value_template: "{{ states('sensor.power_main_total_active_power') | float | round(0) }}"
        unit_of_measurement: "W"

input_text:
  teams_status:
    name: Microsoft Teams status
    icon: mdi:microsoft-teams
  teams_activity:
    name: Microsoft Teams activity
    icon: mdi:phone-off

input_boolean:
  trigger_forecast_update:
    name: Trigger Forecast Update
    initial: off
    icon: mdi:update

http:

logger:
  default: info
  logs:
    homeassistant.components.python_script: debug
    custom_components.sensor_history: debug
    homeassistant.components.sensor: debug